{% extends "homepage/attoHome_base.html" %}
{% load staticfiles %}
{% load custom_tags %}

{% block additional_assets %}
<script>
$(document).ready(function()
{
    var itemId = {{item.id}};

    $('#itemQuantityMinus').click(function()
    {
        var currentQuantity = $('#itemQantity').val()*1;
        if(currentQuantity > 1)
        {
            $('#itemQantity').val(currentQuantity-1);

            var beforeSale = $('#beforeSale').text() * 1.0;
            var price = $('#itemPrice').text().slice(0,-1) * 1.0;

            if( {{item.sale}} == 0 )
            {
                $('#itemPrice').text(price/2+'원')
            }
            else
            {
                $('#beforeSale').text(beforeSale/2)
                $('#itemPrice').text(price/2+'원')
            }
        }
    });

    $('#itemQantity').on('change',function()
    {
        var quantity = $('#itemQantity').val()*1.0
        if(quantity < 1)
        {
            alert('1개보다 적게 주문할 수 없습니다.');
            $('#itemQantity').val('1')
        }
        else if(quantity >30)
        {
            alert('대량 주문은 1대1 문의로 해주세요.');
            $('#itemQantity').val('1')
        }
        else if(quantity > {{item.stock}})
        {
            alert('재고가 부족합니다 현재 재고는 {{item.stock}}개 입니다.');
            $('#itemQantity').val('{{item.stock}}')
        }
        else
        {

            var beforeSale = {% sub item.price item.sale %} * 1.0;
            var price = {{ item.price }} * 1.0;

            if( {{item.sale}} == 0 )
            {
                $('#itemPrice').text(price*quantity+'원')
            }
            else
            {
                $('#beforeSale').text(beforeSale*quantity)
                $('#itemPrice').text(price*quantity+'원')
            }
        }
    });


    $('#itemQuantityPlus').click(function()
    {
        var currentQuantity = $('#itemQantity').val()*1;
        if(currentQuantity < {{item.stock}} && currentQuantity<30)
        {
            $('#itemQantity').val(currentQuantity+1);

            var beforeSale = $('#beforeSale').text() * 1.0;
            var price = $('#itemPrice').text().slice(0,-1) * 1.0;

            if( {{item.sale}} == 0 )
            {
                $('#itemPrice').text(price*2+'원')
            }
            else
            {
                $('#beforeSale').text(beforeSale*2)
                $('#itemPrice').text(price*2+'원')
            }
        }
        else if(currentQuantity < 30)
        {
           alert('재고가 부족합니다');
        }
        else
        {
            alert('대량 구매는 1:1 문의로 주시기 바랍니다');
        }
    });

    var isNotNull = "{{item}}";
    if( isNotNull !='' && isNotNull !='undefined' )
    {
        itemId = {{item.id}};
        $.ajax(
        {
            method:'GET',
            url:'getReviews',
            data:{'itemId':itemId,},
            success: function(data)
            {
                reviews = data.reviews

                for(flag in reviews)
                {
                    var review = reviews[flag]
                    if(review.img != null)
                    {
                        $('#reviewList').append('\
                            <div class="reviewItem row">\
                                <div class="reviewImg col-xs-4">\
                                    <a href="'+ review.img + '">\
                                        <img class="img-responsive" src="' + review.img + '">\
                                    </a>\
                                </div>\
                                <div class="col-xs-8">\
                                    <p style="float:right; background-color: white;">'+ review.id + ' | ' + review.date + '</p>\
                                    <div class="reviewTxt">' + review.content+'</div>\
                                </div>\
                            </div>\
                        ')
                    }
                    else
                    {
                        $('#reviewList').append('\
                            <div class="reviewItem row">\
                                <div class="col-xs-12" style="padding:0px">\
                                    <p style="float:right; background-color: white;">'+ review.id + ' | ' + review.date + '</p>\
                                    <div class="reviewTxt">' + review.content+'</div>\
                                </div>\
                            </div>\
                        ')
                    }
                }
            },
            error: function(error)
            {
                console.log(error)
            },
        });
    }
    $('#shopingBasketBtn').click(function()
    {
        itemId = {{item.id}}
        $.ajax(
        {
            method:'POST',
            url:'addShoppingBasket',
            data:{'itemId':itemId,'csrfmiddlewaretoken':'{{ csrf_token }}'},
            success: function(data)
            {
                alert('장바구니에 추가되었습니다.');
            },
            error: function(error)
            {
                alert('장바구니에 넣기 실패 하였습니다.');
                console.log(error);
            }
        });

    });

});

</script>

{% endblock additional_assets %}

{% block main_content %}
<div id="itemDetailContainer">
    {% if item %}
    <!-- 상품 디테일 -->
        <div id="itemContent" class="row">
            <div class="col-xs-12 col-sm-6">
                <img src="{{MEDIA_URL}}/{{item.image}}" class="img-responsive">
            </div>
            <div class="col-xs-12 col-sm-6">
                <div class="row">
                    <!--TODO:카테고리에 따른 이름 나오도록 -->
                    <p>(DEV) 분류 : {{item.category}}</p>
                </div>
                <div class="row">
                    <h3>{{item.itemName}}</h3>
                </div>
                <div class="row">
                    {% if item.sale == 0 %}
                        <p id="itemPrice">{{item.price}}원</p>
                    {% else %}
                        <del><small id="beforeSale">{{ item.price }}</small></del>
                        <p id="itemPrice">{% sub item.price item.sale %}원</p>
                    {% endif%}
                </div>
                <div class="row">
                    <button id="itemQuantityMinus">
                        <img src="{{MEDIA_URL}}icons/minus.png">
                    </button>
                    <input type="text" id="itemQantity" value="1" size ="1vw">
                    <button id="itemQuantityPlus">
                            <img src="{{MEDIA_URL}}icons/plus.png">
                    </button>
                </div>
                <br>
                <div class="row">
                    <div class="col-xs-6">
                        <button id="shopingBasketBtn" class="btn btn-default">
                            장바구니
                        </button>
                    </div>
                    <div class="col-xs-6">
                        <button class="btn btn-primary">
                            바로구매
                        </button>
                    </div>
                </div>
                <div id="itemInfo" class="row">
                    <p>
                        {{item.info}}
                    </p>
                </div>
            </div>
        </div>
    <!-- 리뷰 -->
        <div id="itemReviews">
            <h4>Review</h4>
            <div id="reviewMenu">
                {% if request.user.is_authenticated %}
                    <div id="reviewAdd">
                        <button type="button" class="btn btn-default" data-toggle="modal" data-target="#myModal" >리뷰 등록</button>
                    </div>
                    <br><br>
                {% else %}
                    <div id="reviewAdd">
                        <button type="button" class="btn btn-default" onclick="window.location.href='/login'"> 로그인 </button>
                        <button type="button" class="btn btn-default" onclick="window.location.href='/signup'"> 회원 가입 </button>
                    </div>
                {% endif %}
            </div>
            <div id="reviewList">
            </div>
        </div>
    {% else %}
        <h2>error<br>Can not find Item</h2>
    {% endif %}
</div>

<!-- modal-->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">리뷰 등록</h4>
      </div>
      <form id="reviewForm" class="form-inline" method="post" action="addReview" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-body">
             <div class="row">
                  <div class="col-xs-2">
                      <p>{{request.user.username}}</p>
                  </div>
                  <div class="col-xs-10">
                      <textarea class="form-control" rows="3" style="width:100%" name="reviewContent"></textarea>
                  </div>
             </div>
             <div class="row">
                  <div class="col-xs-12">
                      <input type="file" name="uploadReviewImg">
                  </div>
             </div>
             <input type="hidden" name="itemId" value="{{item.id}}">
        </div>
        <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">취소</button>
              <button id="reviewSendBtn" type="submit" class="btn btn-primary">등록</button>
        </div>
       </form>
    </div>
  </div>
</div>
<!-- modal End-->
{% endblock main_content %}
